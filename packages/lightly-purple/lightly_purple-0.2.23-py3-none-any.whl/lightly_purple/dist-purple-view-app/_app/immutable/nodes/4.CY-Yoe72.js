import{c as st,a as v,t as z,n as wt}from"../chunks/CYqQTk2G.js";import{a as B,i as X,c as lt,d as k,b as St,p as kt}from"../chunks/ljGkMZWX.js";import{p as gt,y as _t,z as yt,q as C,e as At,f as rt,a as ht,v as S,j as e,c as H,l as m,r as j,s as ut,t as J}from"../chunks/Cj1lW-Gn.js";import{f as It,g as dt,h as pt,i as Lt,b as O,c as vt,u as Ct,j as Ht}from"../chunks/BQEJVgPf.js";import{r as jt}from"../chunks/Cbydd1_z.js";import{c as zt,P as Ft}from"../chunks/BBLiiV7J.js";import{G as Gt}from"../chunks/BTrFHCUX.js";import{a as Mt,g as D,u as Et}from"../chunks/eiVfNh6z.js";import"../chunks/DvURYSWS.js";import{a as Rt,S as Vt}from"../chunks/CD_eMhOw.js";const Pt=async({dataset_id:y,offset:t=0,limit:d=10,annotation_label_ids:A,tag_ids:c})=>{const g={data:[],error:void 0};try{const s=await zt.GET("/api/datasets/{dataset_id}/annotations",{params:{path:{dataset_id:y},query:{annotation_label_ids:A,tag_ids:c,offset:t,limit:d}}});if(s.error)throw new Error(JSON.stringify(s.error,null,2));if(!s.data)throw new Error("No data");g.data=s.data}catch(s){g.error="Error loading annotations: "+String(s)}return g};var Wt=z('<div><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!></a></div>'),Dt=z('<div slot="noMore"></div>'),Ot=z('<div slot="noResults"></div>'),Bt=z('<div class="viewport flex-1 svelte-1ppli2f"><!></div>'),Tt=z('<div class="flex h-full w-full items-center justify-center"><div>Loading grid...</div></div>');function Ut(y,t){gt(t,!0);const[d,A]=lt(),c=()=>k(Y,"$infiniteLoaderIdentifier",d),g=()=>k(t.selectedAnnotationFilterIds,"$selectedAnnotationFilterIds",d),s=()=>k(_,"$tagsSelected",d),I=()=>k(h,"$pickedAnnotationIds",d),{tagsSelected:_}=It({dataset_id:t.dataset_id,kind:["annotation"]}),{getDatasetVersion:F}=dt();let T=C(""),U=C(!1);_t(async()=>{S(T,B(await F(t.dataset_id))),S(U,!0)});let Y=yt([t.selectedAnnotationFilterIds,_],([l,i])=>l.join(",")+Array.from(i).join(",")),f=C(0);const G=100;let a=C(B([])),R=C(null);At(()=>{c(),S(a,B([])),S(f,0)});async function K({detail:{loaded:l,complete:i}}){const p=await Pt({dataset_id:t.dataset_id,limit:G,offset:e(f),annotation_label_ids:g().length>0?g():void 0,tag_ids:s().size>0?Array.from(s()):void 0});p.data.length?(S(f,e(f)+G),e(a).push(...p.data),p.data.length<G?i():l()):i()}const{selectedSampleAnnotationCropIds:h,toggleSampleAnnotationCropSelection:Q}=dt(),M=16,Z=pt(),[V,ct]=Z;var q=st(),b=rt(q);{var $=l=>{var i=Bt(),p=H(i);const et=m(()=>t.itemHeight+M),nt=m(()=>t.itemWidth+M),n=m(()=>{var r;return((r=e(R))==null?void 0:r.clientHeight)||0});Gt(p,{get itemCount(){return e(a).length},get itemHeight(){return e(et)},get itemWidth(){return e(nt)},get height(){return e(n)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${t.itemWidth??""}px; --sample-height: ${t.itemHeight??""}px;`},item:(E,o)=>{let u=()=>o==null?void 0:o().index,L=()=>o==null?void 0:o().style;var x=st(),w=rt(x);{var W=at=>{var N=Wt(),it=H(N),mt=H(it);const ft=m(()=>I().has(e(a)[u()].annotation_id));Rt(mt,{onSelect:()=>Q(e(a)[u()].annotation_id),get isSelected(){return e(ft)}}),j(it);var ot=ut(it,2),bt=H(ot);Xt(bt,{get annotation(){return e(a)[u()]},get width(){return t.itemWidth},get height(){return t.itemHeight},get cachedDatasetVersion(){return e(T)}}),j(ot),j(N),J(xt=>{O(N,L()),vt(ot,"href",xt)},[()=>V(jt.toSampleWithAnnotation(e(a)[u()].sample.sample_id,e(a)[u()].annotation_id),void 0)]),v(at,N)};X(w,at=>{e(a)[u()]&&e(a)[u()].sample&&at(W)})}v(E,x)},footer:E=>{Lt(E,{get identifier(){return c()},$$events:{infinite:K},$$slots:{noMore:(o,u)=>{var L=Dt();v(o,L)},noResults:(o,u)=>{var L=Ot();v(o,L)}}})},$$slots:{item:!0,footer:!0}}),j(i),St(i,r=>S(R,r),()=>e(R)),v(l,i)},tt=l=>{var i=Tt();v(l,i)};X(b,l=>{e(U)?l($):l(tt,!1)})}v(y,q),ht(),A()}var qt=wt("<svg><!></svg>"),Nt=z('<div class="crop rounded-lg bg-black svelte-gmc1jx"><div><div class="annotation-label text-sm text-white svelte-gmc1jx"></div> <!></div></div>'),Jt=z('<div class="crop flex items-center justify-center rounded-lg bg-black svelte-gmc1jx"><div class="text-xs text-gray-400">Loading...</div></div>');function Xt(y,t){gt(t,!0);const[d,A]=lt(),c=()=>k(Y,"$customLabelColorsStore",d),g=()=>k(ct,"$taskMap",d),s=()=>k(U,"$isHidden",d);let I=kt(t,"cachedDatasetVersion",3,"");const _=20,F=t.annotation.sample,{getDatasetVersion:T}=dt(),{isHidden:U}=Mt(),{customLabelColorsStore:Y}=Et();let f=C(B(I())),G=C(!!I());_t(async()=>{!I()&&t.annotation.annotation_id&&(S(f,B(await T(t.annotation.annotation_id.split("-")[0]))),S(G,!0))});function a(){return Math.min(t.width/(t.annotation.width+_*2),t.height/(t.annotation.height+_*2))}function R(){const n=a();return-(t.annotation.x-_)*n+(t.width-(t.annotation.width+_*2)*n)/2}function K(){const n=a();return-(t.annotation.y-_)*n+(t.height-(t.annotation.height+_*2)*n)/2}let h=t.annotation.annotation_label.annotation_label_name;const Q=m(()=>{var n;return((n=c()[h])==null?void 0:n.color)??D(h,1).color}),M=m(()=>{var n;return(n=c()[h])==null||n.color,D(h,.4).color}),Z=m(()=>{var n;return((n=c()[h])==null?void 0:n.alpha)??.4}),V=!!t.annotation.segmentation__binary_mask__rle_row_wise,{taskMap:ct}=Ct(),q=m(()=>t.annotation.annotation_task_id&&g().has(t.annotation.annotation_task_id)?g().get(t.annotation.annotation_task_id).is_prediction:!1),b=a(),$=R(),tt=K(),l=m(()=>`${Ft+encodeURIComponent(F.file_path_abs)}${e(f)?`?v=${e(f)}`:""}`);var i=st(),p=rt(i);{var et=n=>{var r=Nt(),P=H(r);let E;var o=H(P);o.textContent=h;var u=ut(o,2);{var L=x=>{var w=qt(),W=H(w);Vt(W,{get segmentation(){return t.annotation.segmentation__binary_mask__rle_row_wise},get width(){return F.width},get colorFill(){return e(M)},get opacity(){return e(Z)}}),j(w),J(()=>vt(w,"viewBox",`${t.annotation.x} ${t.annotation.y} ${t.annotation.width} ${t.annotation.height}`)),v(x,w)};X(u,x=>{V&&x(L)})}j(P),j(r),J((x,w,W)=>{O(r,`
        width: ${t.width}px;
        height: ${t.height}px;
        background-image: url("${e(l)}");
        background-position: ${$}px ${tt}px;
        background-size: ${F.width*b}px ${F.height*b}px;
        background-repeat: no-repeat;
    `),E=Ht(P,1,"annotation-box svelte-gmc1jx",null,E,x),O(P,w),O(o,W)},[()=>({"annotation-hidden":s()}),()=>`
            left: ${(t.width-t.annotation.width*b)/2}px;
            top: ${(t.height-t.annotation.height*b)/2}px;
            width: ${t.annotation.width*b}px;
            height: ${t.annotation.height*b}px;
            border-color: ${V?"transparent":e(Q)??D(h).color};
            background-color: ${V?"transparent":e(M)??D(h,.4).color};
            border-style: ${e(q)?"dashed":"solid"};
            
        `,()=>`background-color: ${e(M)??D(h,.4).color};`]),v(n,r)},nt=n=>{var r=Jt();J(()=>O(r,`width: ${t.width}px; height: ${t.height}px;`)),v(n,r)};X(p,n=>{e(G)?n(et):n(nt,!1)})}v(y,i),ht(),A()}function oe(y,t){const[d,A]=lt(),c=()=>k(_,"$boundedSampleSize",d),{datasetId:g,sampleSize:s,selectedAnnotationFilterIds:I}=t.data,_=s.sampleSize;Ut(y,{get itemHeight(){return c().height},get itemWidth(){return c().width},dataset_id:g,selectedAnnotationFilterIds:I}),A()}export{oe as component};
