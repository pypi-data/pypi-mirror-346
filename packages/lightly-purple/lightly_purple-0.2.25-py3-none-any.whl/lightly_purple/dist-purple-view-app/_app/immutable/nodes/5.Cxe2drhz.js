import{n as He,a as h,t as k,r as Ae,c as te}from"../chunks/CCHOD-L1.js";import{p as re,d as p,c as D,r as je,a as F,i as ae,b as Ie}from"../chunks/BkOFT6Jj.js";import{e as ke,k as Le,c as R,j as ze,g as oe,l as Re,a as Me,d as Pe,f as Ee,m as Oe,h as We,i as Ve,b as Ge}from"../chunks/OyE1vH6U.js";import{P as qe,c as Ce,r as Ne}from"../chunks/CRLA7a-5.js";import"../chunks/B48UUeh1.js";import{p as J,c as M,g as t,r as I,t as K,a as U,A as le,k as _,i as H,m as Te,j as T,f as se,d as B,s as ie}from"../chunks/Db_QKtB5.js";import{G as Be}from"../chunks/DKSIxY7-.js";import{a as De}from"../chunks/BK6Q2Dkz.js";import{S as Je}from"../chunks/D2Zhl4bK.js";import{a as Ke}from"../chunks/CpCXJ9mc.js";var Ue=He('<svg style="position: absolute; top: 0; left: 0;"><g></g></svg>');function Ye(c,e){J(e,!0);const[s,m]=D(),r=()=>p(g,"$isHidden",s),o=re(e,"sampleImageObjectFit",3,"contain"),{isHidden:g}=De();var a=Ue(),i=M(a);let l;ke(i,21,()=>e.sample.annotations,Le,(n,w)=>{Je(n,{get annotation(){return t(w)},get showLabel(){return e.showLabel},get imageWidth(){return e.sample.width}})}),I(i),I(a),K(n=>{R(a,"viewBox",`0 0 ${e.sample.width} ${e.sample.height}`),R(a,"preserveAspectRatio",o()==="contain"?"xMidYMid meet":"xMidYMid slice"),R(a,"width",e.containerWidth),R(a,"height",e.containerHeight),l=ze(i,0,"svelte-10ogmpt",null,l,n)},[()=>({"annotations-hidden":r()})]),h(c,a),U(),m()}var Qe=k("<img>");function Xe(c,e){J(e,!0);const s=re(e,"objectFit",3,"contain"),m=je(e,["$$slots","$$events","$$legacy","sample","objectFit"]),{class:r,...o}=m,{getDatasetVersion:g}=oe();let a=H("");le(async()=>{var n;(n=e.sample)!=null&&n.dataset_id&&_(a,F(await g(e.sample.dataset_id)))});var i=Qe();let l;K(n=>l=Me(i,l,{src:`${qe}${e.sample.file_path_abs}${t(a)?`?v=${t(a)}`:""}`,alt:e.sample.file_path_abs,class:n,decoding:"async",style:`--object-fit: ${s()??""}`,loading:"lazy",...o},"svelte-1c6bz0a"),[()=>Re("sample-image rounded-lg bg-black",r)]),Ae(i),h(c,i),U()}const ne=new Map,Ze=(c,e)=>{const{dataset_id:s,offset:m,limit:r,annotationLabels:o,tagIds:g,min_width:a,max_width:i,min_height:l,max_height:n}=c;return JSON.stringify({dataset_id:s,offset:m,limit:r,annotationLabels:o,tagIds:g,min_width:a,max_width:i,min_height:l,max_height:n,textEmbedding:e})},$e=async({dataset_id:c,offset:e=0,limit:s=10,annotationLabels:m,tagIds:r,min_width:o,max_width:g,min_height:a,max_height:i,textEmbedding:l=[]})=>{const n={data:[],error:void 0},w=Ze({dataset_id:c,offset:e,limit:s,annotationLabels:m,tagIds:r,min_width:o,max_width:g,min_height:a,max_height:i},l),L=ne.get(w);if(L)return L;try{const A=o!==void 0?{min_width:o,max_width:g,min_height:a,max_height:i}:{},j=await Ce.POST("/api/samples/list",{params:{query:{dataset_id:c,offset:e,limit:s,annotation_labels:m,tag_ids:r,...A}},body:{text_embedding:l}});if(j.error)throw new Error(JSON.stringify(j.error,null,2));if(!j.data)throw new Error("No data");n.data=j.data,ne.set(w,n)}catch(A){n.error="Error loading samples: "+String(A)}return n};var et=k('<div class="relative"><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!> <!></a></div>'),tt=k('<div slot="noMore"></div>'),at=k('<div slot="noResults"></div>'),st=k('<div class="viewport flex-1 svelte-gzepom"><!></div>'),it=k('<div class="flex h-full w-full items-center justify-center"><div>Loading...</div></div>');function nt(c,e){J(e,!0);const[s,m]=D(),r=()=>p(w,"$gridViewSampleRenderingStore",s),o=()=>p(j,"$infiniteLoaderIdentifier",s),g=()=>p(A,"$dimensions",s),a=()=>p(e.selectedAnnotationFilter,"$selectedAnnotationFilter",s),i=()=>p(L,"$tagsSelected",s),l=()=>p(e.textEmbedding,"$textEmbedding",s),n=()=>p(de,"$selectedSampleIds",s),{gridViewSampleRenderingStore:w}=Pe(),{tagsSelected:L}=Ee({dataset_id:e.dataset_id,kind:["sample"]}),{dimensionsValues:A}=Oe();let j=Te([e.selectedAnnotationFilter,L,A,e.textEmbedding],([d,u,b,S])=>d.join(",")+Array.from(u).join(",")+b.min_width+b.max_width+b.min_height+b.max_height+(S?S.queryText:"")),P=H(0);const O=100;let f=H(F([])),x=H(null),Y=H(!1);const{selectedSampleIds:de,toggleSampleSelection:ce,getDatasetVersion:me}=oe();let W=H(F(r())),V=H(0);le(async()=>{await me(e.dataset_id),_(Y,!0)}),T(()=>{_(W,F(r()))}),T(()=>{o(),_(f,F([])),_(P,0)}),T(()=>{if(!t(x))return;_(V,F(t(x).clientHeight));const d=new ResizeObserver(()=>{t(x)&&_(V,F(t(x).clientHeight))});return d.observe(t(x)),()=>{d.disconnect()}});async function ge({detail:{loaded:d,complete:u}}){const b=g(),S=await $e({dataset_id:e.dataset_id,limit:O,offset:t(P),annotationLabels:a().length>0?a():void 0,tagIds:i().size>0?Array.from(i()):void 0,textEmbedding:l()?l().embedding:void 0,...b});S.data.length?(_(P,t(P)+O),t(f).push(...S.data),S.data.length<O?u():d()):u()}const Q=16,ue=We(),[ve,rt]=ue;var X=te(),fe=se(X);{var _e=d=>{var u=st(),b=M(u);const S=B(()=>e.sampleHeight+Q),pe=B(()=>e.sampleWidth+Q);Be(b,{get itemCount(){return t(f).length},get itemHeight(){return t(S)},get itemWidth(){return t(pe)},get height(){return t(V)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${e.sampleWidth??""}px; --sample-height: ${e.sampleHeight??""}px;`},overScan:100,item:(G,v)=>{let y=()=>v==null?void 0:v().index,z=()=>v==null?void 0:v().style;var $=te(),be=se($);{var Se=q=>{var E=et(),C=M(E),ye=M(C);const we=B(()=>n().has(t(f)[y()].sample_id));Ke(ye,{onSelect:()=>ce(t(f)[y()].sample_id),get isSelected(){return t(we)}}),I(C);var N=ie(C,2),ee=M(N);Xe(ee,{get sample(){return t(f)[y()]},get objectFit(){return t(W)}});var xe=ie(ee,2);Ye(xe,{get sample(){return t(f)[y()]},get containerWidth(){return e.sampleWidth},get sampleImageObjectFit(){return t(W)},get containerHeight(){return e.sampleHeight}}),I(N),I(E),K(Fe=>{Ge(E,z()),R(N,"href",Fe)},[()=>ve(Ne.toSample(t(f)[y()].sample_id),void 0)]),h(q,E)};ae(be,q=>{t(f)[y()]&&q(Se)})}h(G,$)},footer:G=>{Ve(G,{get identifier(){return o()},$$events:{infinite:ge},$$slots:{noMore:(v,y)=>{var z=tt();h(v,z)},noResults:(v,y)=>{var z=at();h(v,z)}}})},$$slots:{item:!0,footer:!0}}),I(u),Ie(u,Z=>_(x,Z),()=>t(x)),h(d,u)},he=d=>{var u=it();h(d,u)};ae(fe,d=>{t(Y)?d(_e):d(he,!1)})}h(c,X),U(),m()}function pt(c,e){const[s,m]=D(),r=()=>p(g,"$sampleSize",s),{datasetId:o,sampleSize:g,selectedAnnotationFilter:a,globalStorage:{textEmbedding:i}}=e.data;nt(c,{get sampleHeight(){return r().height},get sampleWidth(){return r().width},textEmbedding:i,dataset_id:o,selectedAnnotationFilter:a}),m()}export{pt as component};
