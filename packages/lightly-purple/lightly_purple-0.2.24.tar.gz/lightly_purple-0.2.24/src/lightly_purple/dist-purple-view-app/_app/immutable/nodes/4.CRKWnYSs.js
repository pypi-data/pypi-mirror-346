import{c as lt,a as g,t as L,n as Lt}from"../chunks/CYNiB6_4.js";import{a as j,d as w,i as U,c as gt,b as It,p as _t}from"../chunks/C1afDGGf.js";import{p as ut,i as A,j as vt,A as ft,m as pt,f as ct,a as mt,k as b,g as e,c as F,d as x,r as G,s as bt,t as O}from"../chunks/DpVHSmmX.js";import{f as Ct,d as Ht,g as ht,h as jt,i as Ft,b as B,c as wt,u as Gt,j as Mt}from"../chunks/D41Hqwbn.js";import{c as Et,r as Rt,P as Tt}from"../chunks/CRLA7a-5.js";import{G as Vt}from"../chunks/DU3q3_UE.js";import{a as zt,g as D,u as Pt}from"../chunks/DRUjRZBg.js";import"../chunks/CYcGrRWH.js";import{a as Wt,S as Dt}from"../chunks/DvTsDW6x.js";const Ot=async({dataset_id:I,offset:t=0,limit:i=10,annotation_label_ids:p,tag_ids:_})=>{const v={data:[],error:void 0};try{const o=await Et.GET("/api/datasets/{dataset_id}/annotations",{params:{path:{dataset_id:I},query:{annotation_label_ids:p,tag_ids:_,offset:t,limit:i}}});if(o.error)throw new Error(JSON.stringify(o.error,null,2));if(!o.data)throw new Error("No data");v.data=o.data}catch(o){v.error="Error loading annotations: "+String(o)}return v};var Bt=L('<div><div class="absolute right-7 top-1 z-10"><!></div> <a class="block"><!></a></div>'),Ut=L('<div slot="noMore"></div>'),Nt=L('<div slot="noResults"></div>'),qt=L('<div class="viewport flex-1 svelte-1ppli2f"><!></div>'),Jt=L('<div class="flex h-full w-full items-center justify-center"><div>Loading grid...</div></div>');function Xt(I,t){ut(t,!0);const[i,p]=gt(),_=()=>w(M,"$showAnnotationTextLabelsStore",i),v=()=>w(J,"$infiniteLoaderIdentifier",i),o=()=>w(t.selectedAnnotationFilterIds,"$selectedAnnotationFilterIds",i),S=()=>w(f,"$tagsSelected",i),Q=()=>w(z,"$pickedAnnotationIds",i),{tagsSelected:f}=Ct({dataset_id:t.dataset_id,kind:["annotation"]}),{showAnnotationTextLabelsStore:M}=Ht();let N=A(j(_()));vt(()=>{b(N,j(_()))});const{getDatasetVersion:Z}=ht();let q=A(""),E=A(!1);ft(async()=>{b(q,j(await Z(t.dataset_id))),b(E,!0)});let J=pt([t.selectedAnnotationFilterIds,f],([c,r])=>c.join(",")+Array.from(r).join(",")),k=A(0);const V=100;let l=A(j([])),s=A(null);vt(()=>{v(),b(l,j([])),b(k,0)});async function $({detail:{loaded:c,complete:r}}){const H=await Ot({dataset_id:t.dataset_id,limit:V,offset:e(k),annotation_label_ids:o().length>0?o():void 0,tag_ids:S().size>0?Array.from(S()):void 0});H.data.length?(b(k,e(k)+V),e(l).push(...H.data),H.data.length<V?r():c()):r()}const{selectedSampleAnnotationCropIds:z,toggleSampleAnnotationCropSelection:tt}=ht(),R=16,et=jt(),[at,C]=et;var X=lt(),nt=ct(X);{var it=c=>{var r=qt(),H=F(r);const a=x(()=>t.itemHeight+R),m=x(()=>t.itemWidth+R),T=x(()=>{var y;return((y=e(s))==null?void 0:y.clientHeight)||0});Vt(H,{get itemCount(){return e(l).length},get itemHeight(){return e(a)},get itemWidth(){return e(m)},get height(){return e(T)},class:"overflow-none overflow-y-auto dark:[color-scheme:dark]",get style(){return`--sample-width: ${t.itemWidth??""}px; --sample-height: ${t.itemHeight??""}px;`},item:(P,h)=>{let u=()=>h==null?void 0:h().index,n=()=>h==null?void 0:h().style;var d=lt(),W=ct(d);{var xt=st=>{var K=Bt(),rt=F(K),St=F(rt);const kt=x(()=>Q().has(e(l)[u()].annotation_id));Wt(St,{onSelect:()=>tt(e(l)[u()].annotation_id),get isSelected(){return e(kt)}}),G(rt);var dt=bt(rt,2),yt=F(dt);$t(yt,{get annotation(){return e(l)[u()]},get width(){return t.itemWidth},get height(){return t.itemHeight},get cachedDatasetVersion(){return e(q)},get showLabel(){return e(N)}}),G(dt),G(K),O(At=>{B(K,n()),wt(dt,"href",At)},[()=>at(Rt.toSampleWithAnnotation(e(l)[u()].sample.sample_id,e(l)[u()].annotation_id),void 0)]),g(st,K)};U(W,st=>{e(l)[u()]&&e(l)[u()].sample&&st(xt)})}g(P,d)},footer:P=>{Ft(P,{get identifier(){return v()},$$events:{infinite:$},$$slots:{noMore:(h,u)=>{var n=Ut();g(h,n)},noResults:(h,u)=>{var n=Nt();g(h,n)}}})},$$slots:{item:!0,footer:!0}}),G(r),It(r,y=>b(s,y),()=>e(s)),g(c,r)},Y=c=>{var r=Jt();g(c,r)};U(nt,c=>{e(E)?c(it):c(Y,!1)})}g(I,X),mt(),p()}var Yt=L('<div class="annotation-label text-sm text-white svelte-gmc1jx"></div>'),Kt=Lt("<svg><!></svg>"),Qt=L('<div class="crop rounded-lg bg-black svelte-gmc1jx"><div><!> <!></div></div>'),Zt=L('<div class="crop flex items-center justify-center rounded-lg bg-black svelte-gmc1jx"><div class="text-xs text-gray-400">Loading...</div></div>');function $t(I,t){ut(t,!0);const[i,p]=gt(),_=()=>w(q,"$customLabelColorsStore",i),v=()=>w(et,"$taskMap",i),o=()=>w(Z,"$isHidden",i);let S=_t(t,"cachedDatasetVersion",3,""),Q=_t(t,"showLabel",3,!0);const f=20,M=t.annotation.sample,{getDatasetVersion:N}=ht(),{isHidden:Z}=zt(),{customLabelColorsStore:q}=Pt();let E=A(j(S())),J=A(!!S());ft(async()=>{!S()&&t.annotation.annotation_id&&(b(E,j(await N(t.annotation.annotation_id.split("-")[0]))),b(J,!0))});function k(){return Math.min(t.width/(t.annotation.width+f*2),t.height/(t.annotation.height+f*2))}function V(){const a=k();return-(t.annotation.x-f)*a+(t.width-(t.annotation.width+f*2)*a)/2}function l(){const a=k();return-(t.annotation.y-f)*a+(t.height-(t.annotation.height+f*2)*a)/2}let s=t.annotation.annotation_label.annotation_label_name;const $=x(()=>{var a;return((a=_()[s])==null?void 0:a.color)??D(s,1).color}),z=x(()=>{var a;return(a=_()[s])==null||a.color,D(s,.4).color}),tt=x(()=>{var a;return((a=_()[s])==null?void 0:a.alpha)??.4}),R=!!t.annotation.segmentation__binary_mask__rle_row_wise,{taskMap:et}=Gt(),at=x(()=>t.annotation.annotation_task_id&&v().has(t.annotation.annotation_task_id)?v().get(t.annotation.annotation_task_id).is_prediction:!1),C=k(),X=V(),nt=l(),it=x(()=>`${Tt+encodeURIComponent(M.file_path_abs)}${e(E)?`?v=${e(E)}`:""}`);var Y=lt(),c=ct(Y);{var r=a=>{var m=Qt(),T=F(m);let y;var ot=F(T);{var P=n=>{var d=Yt();d.textContent=s,O(W=>B(d,W),[()=>`background-color: ${e(z)??D(s,.4).color};`]),g(n,d)};U(ot,n=>{Q()&&n(P)})}var h=bt(ot,2);{var u=n=>{var d=Kt(),W=F(d);Dt(W,{get segmentation(){return t.annotation.segmentation__binary_mask__rle_row_wise},get width(){return M.width},get colorFill(){return e(z)},get opacity(){return e(tt)}}),G(d),O(()=>wt(d,"viewBox",`${t.annotation.x} ${t.annotation.y} ${t.annotation.width} ${t.annotation.height}`)),g(n,d)};U(h,n=>{R&&n(u)})}G(T),G(m),O((n,d)=>{B(m,`
        width: ${t.width}px;
        height: ${t.height}px;
        background-image: url("${e(it)}");
        background-position: ${X}px ${nt}px;
        background-size: ${M.width*C}px ${M.height*C}px;
        background-repeat: no-repeat;
    `),y=Mt(T,1,"annotation-box svelte-gmc1jx",null,y,n),B(T,d)},[()=>({"annotation-hidden":o()}),()=>`
            left: ${(t.width-t.annotation.width*C)/2}px;
            top: ${(t.height-t.annotation.height*C)/2}px;
            width: ${t.annotation.width*C}px;
            height: ${t.annotation.height*C}px;
            border-color: ${R?"transparent":e($)??D(s).color};
            background-color: ${R?"transparent":e(z)??D(s,.4).color};
            border-style: ${e(at)?"dashed":"solid"};
            
        `]),g(a,m)},H=a=>{var m=Zt();O(()=>B(m,`width: ${t.width}px; height: ${t.height}px;`)),g(a,m)};U(c,a=>{e(J)?a(r):a(H,!1)})}g(I,Y),mt(),p()}function le(I,t){const[i,p]=gt(),_=()=>w(o,"$sampleSize",i),{datasetId:v,sampleSize:o,selectedAnnotationFilterIds:S}=t.data;Xt(I,{get itemHeight(){return _().height},get itemWidth(){return _().width},dataset_id:v,selectedAnnotationFilterIds:S}),p()}export{le as component};
