<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
	<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Internet Of Things</title>
	<link rel="stylesheet" href="/static/css/leaflet.css">
	<script src="/static/js/jquery.min.js"></script>
	<script src="/static/js/leaflet.js"></script>

	<style>
    /* Reset basic elements */
    body, html {
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
    }

    /* Make map fill entire viewport */
    #map { 
        position: absolute;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100%;
        z-index: 1;
    }

    /* Main container styling - overlay on top of map */
    .container {
        position: relative;
        z-index: 2;
        display: flex;
        justify-content: space-between;
        gap: 20px;
        padding: 20px;
        height: 20vh;
        min-height: 250px;
        background-color: rgba(248, 249, 250, 0.2); /* Semi-transparent background */
    }

    .box1 {
        flex: 1;
        padding: 20px;
    }

    .box {
        flex: 3;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #8cd2d996;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .container {
            flex-direction: column;
            height: auto;
        }
        #map {
            height: 60vh;
        }
    }


    .city-selector {
        position: relative;
        z-index: 2;
    }

    .header {
        padding-left: 30px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 20px;
    }

    #locationButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: white;
        border: 2px solid rgba(0,0,0,0.2);
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }

    #locationButton:hover {
        background-color: #f4f4f4;
    }

    #locationButton:active {
        background-color: #ebebeb;
    }


    /* Unified styles for both buttons and dropdown */
    #cityDropdown {
        padding: 8px 12px;
        border: 1px solid #132f46;
        border-radius: 4px;
        background-color: white;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 120px;  /* Ensure consistent minimum width */
    }

    #cityDropdown:hover {
        background-color: #16414463;
        border-color: #3d0707;
    }

    #cityDropdown:active {
        background-color: #203236;
    }

    /* Specific styles for dropdowns to handle the arrow */
    #cityDropdown {
        padding-right: 24px;  /* Make room for the dropdown arrow */
        appearance: none;  /* Remove default dropdown arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 12px;
    }

    /* Remove focus outline and add custom focus style */
    #cityDropdown:focus {
        outline: none;
        border-color: #174e3e;
        box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }
    
	</style>

	</head>
	<body>

<div class="container">
    <div class="header">
        <h1 style="font-size: 2.5rem; color: #4d0928; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 0.5rem; font-weight: bold;">ExpEYES IoT</h1>
        <div class="city-selector">
            <select id="cityDropdown" onchange="navigateToCity()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(45deg, #2196F3, #00BCD4); color: white; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s ease;">
                <option value="">Select City</option>
                <option value="11.2588,75.7804">Kozhikode</option>
                <option value="28.6139,77.2090">Delhi</option>
                <option value="19.0760,72.8777">Mumbai</option>
                <option value="12.9716,77.5946">Bangalore</option>
                <option value="13.0827,80.2707">Chennai</option>
                <option value="17.3850,78.4867">Hyderabad</option>
                <option value="22.5726,88.3639">Kolkata</option>
                <option value="23.0225,72.5714">Ahmedabad</option>
                <option value="18.5204,73.8567">Pune</option>
            </select>
        </div>
    </div>
</div>

	<div id="map"></div>

    <button id="locationButton" title="Get my location">
        <i class="fas fa-crosshairs"></i>
    </button>

	</body>


<script>

	var map = L.map('map').setView([11.136, 75.889415], 17);

	L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
		maxZoom: 19,
		attribution: '<a href="/admin">Sensor Admin</a> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
	}).addTo(map);


    function navigateToCity() {
        const coordinates = document.getElementById('cityDropdown').value;
        if (coordinates) {
            const [lat, lng] = coordinates.split(',').map(Number);
            map.setView([lat, lng], 16);
        }
    }


    document.getElementById('locationButton').addEventListener('click', function() {
        if ("geolocation" in navigator) {
            this.disabled = true; // Disable button while loading
            navigator.geolocation.getCurrentPosition(
                // Success callback
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 13);
                    document.getElementById('locationButton').disabled = false;
                },
                // Error callback
                function(error) {
                    console.log('Location access denied or unavailable:', error.message);
                    document.getElementById('locationButton').disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        } else {
            alert("Geolocation is not supported by your browser");
        }
    });

    function fetchCoordinates() {
        fetch('/coordinates')  // Replace with your actual endpoint
            .then(response => response.json())
            .then(data => {
                if (data.latitude && data.longitude) {
                    // Navigate to the new coordinates
                    if (data.changed) {
                        navigateTo(data.latitude, data.longitude);
                    }
                }
            })
            .catch(error => console.error('Error fetching coordinates:', error));
    }

    function navigateTo(latitude, longitude) {
        // Logic to navigate to the new coordinates on the map
        console.log(`Navigating to Latitude: ${latitude}, Longitude: ${longitude}`);
        // Add your map navigation logic here
        map.setView([latitude, longitude]);
    }
    // Poll every 5 seconds
    setInterval(fetchCoordinates, 500);

    function onMapClick(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        // Send a POST request to the /update endpoint with the new coordinates
        fetch('http://localhost:8002/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ latitude: lat, longitude: lng })
        })
        .then(response => {
            if (response.ok) {
                console.log('Coordinates updated successfully');
            } else {
                console.error('Failed to update coordinates');
            }
        })
        .catch(error => console.error('Error:', error));
    }

    map.on('click', onMapClick);  // Attach the click event to the map

	</script>
</html>

