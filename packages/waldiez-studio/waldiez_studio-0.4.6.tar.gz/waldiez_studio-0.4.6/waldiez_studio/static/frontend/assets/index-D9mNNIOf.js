import{r as e,j as t,a}from"./react-BbQoyxJr.js";import{R as s}from"./react-dom-DMAtuLf8.js";import{i as n,W as r}from"./@waldiez-ck4tOYVI.js";import{a as o}from"./axios-CtpuQClY.js";import{H as i,N as l,O as c,P as d,Q as u,R as m,S as p,T as h,U as w,V as f,W as g,X as y,Y as x,Z as j,_ as b,$ as v,a0 as N,a1 as C,a2 as k,a3 as S,a4 as E,a5 as z,a6 as $,a7 as P,a8 as R,a9 as D,a as M,o as F,x as I,aa as T}from"./react-icons-DpYXTlZL.js";import{u as O}from"./react-use-websocket-BfM8dcdF.js";import"./classnames-_XmCIgIR.js";import"./scheduler-CebB03oh.js";import"./jszip-B3TgKVf7.js";import"./nanoid-DjdYu-xF.js";import"./@xyflow-C8U94BfH.js";import"./classcat-Dkggfwne.js";import"./d3-zoom-BRrQlHVn.js";import"./d3-transition-DTrqy8Pa.js";import"./d3-timer-keMr1twq.js";import"./d3-dispatch-Chq_f_hl.js";import"./d3-interpolate-Dl9m2Y4Y.js";import"./d3-color-Cvz4NH3r.js";import"./d3-selection-wmdcUTzl.js";import"./d3-ease-Cx6bG2vu.js";import"./d3-drag-0uTPV4-j.js";import"./use-sync-external-store-EqP_DNu9.js";import"./react-error-boundary-C44yZOB2.js";import"./react-hotkeys-hook-VunKruj6.js";import"./@monaco-editor-Dpi161rQ.js";import"./state-local-BC9ybJZH.js";import"./zustand-CFavtNBg.js";import"./microdiff-CIJmP7K9.js";import"./zundo-DDtCTK_0.js";import"./react-select-C_4W4n0X.js";import"./@babel-DaOQQ1Dt.js";import"./@emotion-CG17nuDd.js";import"./hoist-non-react-statics-CmA2CWkd.js";import"./stylis-h7b_IEWc.js";import"./@floating-ui-DDWPdr0g.js";import"./use-isomorphic-layout-effect-CUVdDInQ.js";import"./memoize-one-Ds0C_khL.js";import"./rc-slider-CRj1Pkjh.js";import"./rc-util-ae55oxUP.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class L extends Error{constructor(e,t,a){super(t),this.status=e,this.originalError=a,this.name="ApiError"}}const U=o.create({baseURL:"/api",timeout:3e4});U.interceptors.response.use((e=>e),(e=>{if("ECONNABORTED"===e.code)return Promise.reject(new L(e.response?.status||0,"Request timed out.",e));let t="An unexpected error occurred.",a=0;return o.isAxiosError(e)&&e.response&&(a=e.response.status,t=W(e)),Promise.reject(new L(a,t,e))}));const W=e=>{let t="An unexpected error occurred.";const a=e.response?.data;return"string"==typeof a?t=a:a?.detail?t=a.detail:a?.message?t=a.message:e.response?.statusText&&(t=`Error: ${e.response.statusText}`),t},A="/workspace",V=async(e="/",t)=>{const a=new FormData;a.append("file",t),a.append("path",e);return(await U.post(`${A}/upload`,a,{headers:{"Content-Type":"multipart/form-data"}})).data},J=e.createContext(void 0),B=()=>{const t=e.useContext(J);if(!t)throw new Error("useFileBrowser must be used within a FileBrowserProvider");return t},q=(e,t)=>{let a=null;return(...s)=>(a&&clearTimeout(a),new Promise(((n,r)=>{a=setTimeout((async()=>{try{const t=await e(...s);n(t)}catch(t){r(t)}}),t)})))},H=e=>!!e.endsWith(".waldiez")||"/"!==e&&""!==e&&!e.endsWith("/")&&e.split("/").pop()?.includes("."),_=e=>{const t=e.split("/").filter(Boolean),a=t.length>1?`/${t.slice(0,-1).join("/")}`:"/";return a===e?"/":a},K=e=>((e=e.replace(/\/+/g,"/")).startsWith("/")||(e=`/${e}`),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e),X=({children:a})=>{const s=e=>{const t=e.split("/");return t[t.length-1]||"Home"},[n,r]=e.useState((()=>{const e=window.location.hash;return e&&e.length>1?e.slice(1):"/"})()),[o,i]=e.useState(s(n)),[l,c]=e.useState([]),[d,u]=e.useState(null),[m,p]=e.useState(!1);e.useEffect((()=>{(async()=>{H(n)?await h(_(n)):await h(n),i(s(n))})()}),[n]);const h=async e=>{p(!0),u(null);try{const t=await(async(e="/")=>(await U.get(A,{params:["","/"].includes(e)?{}:{parent:e}})).data)(e),a="/"!==e?[{name:"..",path:_(e),type:"folder"}]:[];c([...a,...t.items])}catch(t){u(t instanceof Error?t.message:"An unexpected error occurred.")}finally{p(!1)}},w=q(h,200),f=e=>{const t=K(e);return r(t),window.location.hash=`#${t}`,t},g=async(e,t=!0)=>{if(e.path===n||`/${e.path}`===n)return;const a=f(e.path);"file"!==e.type&&(t?await h(a):await w(a))},y=async(e=!1)=>{const t=K(n);let a=t;H(t)&&(a=_(t)),e?await h(a):await w(a)};return t.jsx(J.Provider,{value:{currentPath:n,pathName:o,entries:l,error:d,loading:m,setError:u,refresh:y,onGoUp:async()=>{const e=_(n);await g({path:e,type:"folder"})},onNavigate:g,onCreate:async e=>{const t=H(n)?_(n):n;try{"folder"===e?await(async(e="/")=>(await U.post(A,{type:"folder",parent:e})).data)(t):"file"===e&&await(async(e="/")=>(await U.post(A,{type:"file",parent:e})).data)(t)}catch(a){u(`Failed to create ${e}: ${a.message}`)}finally{await y(!0)}},onDelete:async e=>{try{await(async(e="/")=>{const t=["","/"].includes(e)?"":`?path=${encodeURIComponent(e)}`;return(await U.delete(`${A}${t}`)).data})(e.path),e.path!==n&&`/${e.path}`!==n||f(_(e.path))}catch(t){u(`Failed to delete entry: ${t.message}`)}finally{await y()}},onRename:async(e,t)=>{if(e.name!==t)try{const a=`${_(e.path)}/${t}`;await(async(e,t)=>(await U.post(`${A}/rename`,{old_path:e,new_path:t},{headers:{"Content-Type":"application/json"}})).data)(e.path,a),e.path!==n&&`/${e.path}`!==n||f(a)}catch(a){u(`Failed to rename entry: ${a.message}`)}finally{await y(!0)}},onUpload:async e=>{const t=K(n);p(!0);try{H(t)?await V(_(t),e):await V(t,e)}catch(a){u(`Failed to upload file: ${a.message}`)}finally{p(!1),await y()}},onDownload:async e=>{try{await(async(e,t)=>{const a=await U.get(`${A}/download?path=${encodeURIComponent(e)}`,{responseType:"blob"}),s=window.URL.createObjectURL(new Blob([a.data])),n=document.createElement("a");n.href=s;const r=e.split("/");let o=r[r.length-1];"folder"===t&&(o+=".zip"),n.download=o,n.click(),window.URL.revokeObjectURL(s)})(e.path,e.type)}catch(t){u(`Failed to download entry: ${t.message}`)}}},children:a})},Y=({onNewFile:a,onNewFolder:s,onUpload:n})=>{const r=e.useRef(null);return t.jsxs("div",{className:"actions-buttons",children:[t.jsxs("button",{className:"action-button",onClick:a,children:[t.jsx(i,{"aria-hidden":"true"}),"New Flow"]}),t.jsxs("button",{className:"action-button",onClick:s,children:[t.jsx(i,{"aria-hidden":"true"}),"New Folder"]}),t.jsxs("button",{"data-testid":"upload-button",className:"action-button",onClick:()=>r.current?.click(),children:[t.jsx(l,{"aria-hidden":"true"}),"Upload"]}),t.jsx("input",{title:"Upload File","data-testid":"file-input",type:"file",ref:r,style:{display:"none"},onChange:async e=>{if(!e.target.files||0===e.target.files.length)return;const t=e.target.files[0];try{await n(t)}catch(a){}finally{e.target.value=""}}})]})},G=({isSidebarVisible:e,refresh:a,loading:s,toggleSidebar:n})=>t.jsxs("div",{className:"file-browser-toggle",style:{justifyContent:e?"space-between":"center"},children:[e&&t.jsxs("div",{className:"file-browser-header",children:[t.jsx("h3",{children:"Workspace"}),t.jsx("button",{onClick:a,disabled:s,title:"Refresh","data-testid":"refresh-button","aria-label":"Refresh",className:"file-browser-refresh",style:{cursor:s?"not-allowed":"pointer",opacity:s?.7:1},children:s?t.jsx(c,{"aria-hidden":"true",className:"spinner"}):t.jsx(d,{"aria-hidden":"true"})})]}),t.jsx(u,{role:"button",className:"file-browser-toggle-icon",onClick:n,"aria-hidden":"true"})]}),Q=a=>{const{item:s,currentPath:n,onDelete:r,onRename:o,onNavigate:i,onDownload:l}=a,[c,d]=e.useState(!1),[u,P]=e.useState(s.name),[R,D]=e.useState(!1),[M,F]=e.useState(null),I=e.useRef(null),T=(e=>{const a=e.split(".").pop(),s="path-item-icon";if(!a)return t.jsx(m,{className:s});switch(a){case"waldiez":case"waldiezModel":case"waldiezSkill":case"waldiezAgent":return t.jsx("img",{src:"/frontend/assets/logo-CJWt5vHt.svg",className:`${s} waldiez-file`,alt:"logo",title:"Waldiez Flow"});case"xml":return t.jsx($,{className:s,title:"XML"});case"txt":case"doc":case"docx":return t.jsx(z,{className:s,title:"Text"});case"pdf":return t.jsx(E,{className:s,title:"PDF"});case"jpg":case"jpeg":case"png":case"gif":case"bmp":case"webp":case"svg":case"ico":case"tiff":return t.jsx(S,{className:s,title:"Image"});case"mp3":case"wav":case"ogg":case"flac":case"aac":case"wma":case"m4a":case"aiff":case"alac":return t.jsx(k,{className:s,title:"Audio"});case"mp4":case"avi":case"mov":case"wmv":case"flv":case"mkv":case"webm":case"mpeg":case"3gp":return t.jsx(C,{className:s,title:"Video"});case"zip":case"rar":case"tar":case"gz":case"bz2":case"7z":case"xz":return t.jsx(N,{className:s,title:"Archive"});case"py":case"pyc":case"pyo":case"pyd":return t.jsx(v,{className:s,title:"Python"});case"php":return t.jsx(b,{className:s,title:"PHP"});case"java":case"jar":return t.jsx(j,{className:s,title:"Java"});case"ipynb":return t.jsx(x,{className:s,title:"Jupyter Notebook"});case"json":return t.jsx(y,{className:s,title:"JSON"});case"yaml":case"yml":return t.jsx(g,{className:s,title:"YAML"});case"md":return t.jsx(f,{className:s,title:"Markdown"});case"sqlite":case"db":return t.jsx(w,{className:s,title:"SQLite"});case"js":case"jsx":case"mjs":case"cjs":return t.jsx(h,{className:s,title:"JavaScript"});case"ts":case"tsx":case"html":case"css":case"scss":case"less":case"toml":case"ini":case"env":case"sh":case"bat":case"cmd":case"ps1":case"psm1":case"bash":case"zsh":case"fish":case"kt":case"kts":case"c":case"cpp":case"h":case"hpp":case"cs":case"go":case"rb":case"rs":case"clj":case"edn":case"scala":case"groovy":case"pl":case"pm":return t.jsx(p,{className:s,title:"Code"});default:return t.jsx(m,{className:s,title:"File"})}})(s.name);e.useEffect((()=>{P(s.name)}),[s]),e.useEffect((()=>{const e=e=>{R&&I.current&&!I.current.contains(e.target)&&U()};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}}),[R]);const O=()=>{if("folder"===s.type&&".."===s.name)return!0;const e=s.path;return"folder"===s.type&&n!==e||!("file"!==s.type||!s.name.endsWith(".waldiez")||n===e)},L=null!==i&&O(),U=()=>{D(!1),F(null)};return{isEditing:c,newName:u,fileIcon:T,canClick:L,contextMenuVisible:R,contextMenuPosition:M,contextMenuRef:I,setIsEditing:d,handleDelete:async()=>{r&&await r(s)},handleRename:async()=>{d(!1),u!==s.name&&o&&await o(s,u)},handleDownload:async()=>{l&&await l(s)},onNameChange:e=>{P(e.target.value)},handleCancel:()=>{d(!1),P(s.name)},canNavigate:O,handleContextMenu:e=>{e.preventDefault(),D(!0),F({x:e.clientX,y:e.clientY})},closeContextMenu:U}},Z=({currentPath:e,item:a,onRename:s,onDelete:n,onNavigate:r,onDownload:o})=>{const{isEditing:i,newName:l,fileIcon:c,canClick:d,contextMenuVisible:u,contextMenuPosition:m,contextMenuRef:p,setIsEditing:h,handleDelete:w,handleRename:f,handleDownload:g,onNameChange:y,handleCancel:x,handleContextMenu:j,closeContextMenu:b}=Q({currentPath:e,item:a,onRename:s,onDelete:n,onNavigate:r,onDownload:o}),v=e=>{"Enter"===e.key?f():"Escape"===e.key&&x()};return t.jsxs("div",{"data-testid":"path-item",className:`path-item ${d?"":"read-only"} ${".."===a.name?"up":""}`,onContextMenu:j,children:[u&&m&&".."!==a.name&&t.jsx("div",{ref:p,style:{top:m.y,left:m.x},className:"context-menu",children:t.jsx("button",{onClick:async()=>{await g(),b()},className:"context-menu-item","data-testid":"download-button",children:"Download"})}),i?t.jsx(P,{className:"path-item-edit",onClick:x}):"folder"===a.type?t.jsx(R,{className:"path-item-icon"}):c,i?t.jsx("input",{title:"Press Enter to save, Esc to cancel",type:"text",className:"path-name-input","data-testid":"path-name-input",value:l,onChange:y,onKeyDown:v}):d&&r?t.jsx("span",{className:"path-name clickable","data-testid":"path-navigate",onClick:r.bind(null,a),children:a.name}):t.jsx("div",{className:"path-name",children:a.name}),".."!==a.name&&s?i?t.jsx(D,{className:"path-item-edit","data-testid":"save-button",onClick:f}):t.jsx(M,{className:"path-item-edit","data-testid":"edit-button",onClick:()=>h(!0)}):null,".."!==a.name&&n?t.jsx(F,{className:"path-item-delete","data-testid":"delete-button",onClick:w}):null]})},ee=e.createContext(void 0),te=({children:a,initialVisible:s=!0})=>{const[n,r]=e.useState(s);return t.jsx(ee.Provider,{value:{isSidebarVisible:n,toggleSidebar:()=>r((e=>!e))},children:a})},ae=()=>{const{entries:a,loading:s,refresh:n,onNavigate:r,onCreate:o,onDelete:i,onRename:l,onUpload:c,onDownload:d,currentPath:u,error:m}=B(),{isSidebarVisible:p,toggleSidebar:h}=(()=>{const t=e.useContext(ee);if(!t)throw new Error("useSidebar must be used within a SidebarProvider");return t})();return t.jsxs("div",{className:"file-browser",style:{width:p?"250px":"60px"},children:[t.jsx(G,{isSidebarVisible:p,refresh:n,loading:s,toggleSidebar:h}),t.jsx("div",{className:"file-browser-content",children:p&&t.jsxs(t.Fragment,{children:[m&&t.jsx("p",{className:"file-browser-error","data-testid":"error",children:m}),a.map((e=>t.jsx(Z,{currentPath:u,item:e,onDelete:i,onRename:l,onNavigate:r,onDownload:d},e.path)))]})}),p&&t.jsx(Y,{onNewFile:async()=>{await o("file")},onNewFolder:async()=>{await o("folder")},onUpload:c})]})},se={0:{},1:{fontWeight:"bold"},3:{fontStyle:"italic"},4:{textDecoration:"underline"},7:{filter:"invert(100%)"},9:{textDecoration:"line-through"},22:{fontWeight:"normal"},23:{fontStyle:"normal"},24:{textDecoration:"none"},27:{filter:"none"},29:{textDecoration:"none"},30:{color:"var(--ansi-black)"},31:{color:"var(--ansi-red)"},32:{color:"var(--ansi-green)"},33:{color:"var(--ansi-yellow)"},34:{color:"var(--ansi-blue)"},35:{color:"var(--ansi-magenta)"},36:{color:"var(--ansi-cyan)"},37:{color:"var(--ansi-white)"},90:{color:"var(--ansi-bright-yellow)"},40:{backgroundColor:"var(--ansi-black)"},41:{backgroundColor:"var(--ansi-red)"},42:{backgroundColor:"var(--ansi-green)"},43:{backgroundColor:"var(--ansi-yellow)"},44:{backgroundColor:"var(--ansi-blue)"},45:{backgroundColor:"var(--ansi-magenta)"},46:{backgroundColor:"var(--ansi-cyan)"},47:{backgroundColor:"var(--ansi-white)"}},ne=/\u001b\[([0-9;]+)m(.*?)(?=\u001b\[|$)|\u001b\[([0-9;]+)m/g,re=({text:e})=>{const a=(e=>{const t=[];let a=0,s={};if(e.replace(ne,((n,r,o="",i,l)=>{if(a<l){const n=e.slice(a,l);n.trim()&&t.push({text:n,style:{...s}})}return(r||i||"").split(";").forEach((e=>{"0"===e?s={}:se[e]&&(s={...s,...se[e]})})),o.trim()&&t.push({text:o,style:{...s}}),a=l+n.length,""})),a<e.length){const n=e.slice(a);n.trim()&&t.push({text:n,style:{...s}})}return t})(e);return t.jsx("span",{children:a.map(((e,a)=>t.jsx("span",{style:e.style,children:e.text},a)))})},oe=({isOpen:a,title:s,messages:n,prompt:r,onClose:o,onSubmit:i})=>{const[l,c]=e.useState(""),d=e.useRef(null),u=e=>{e.preventDefault(),r&&(i(l),c(""))};return e.useEffect((()=>{d.current&&d.current.scrollIntoView({behavior:"smooth"})}),[n]),a&&0!==n.length?t.jsx("div",{className:"waldiez-studio-flow-modal",children:t.jsxs("div",{className:"waldiez-studio-flow-modal-content",children:[t.jsxs("div",{className:"waldiez-studio-flow-modal-header",children:[t.jsx("h2",{children:s}),t.jsx("div",{className:"modal-close-btn clickable",role:"button",title:"Close","data-testid":"modal-close-btn",onClick:()=>{o()},children:t.jsx(I,{})})]}),t.jsxs("div",{className:"waldiez-studio-flow-messages-container",children:[t.jsx("ul",{children:n.map(((e,a)=>t.jsx("li",{children:t.jsx(re,{text:e})},a)))}),t.jsx("div",{ref:d})]}),r&&t.jsx("div",{className:"waldiez-studio-flow-prompt-view",children:r}),t.jsxs("div",{className:"waldiez-studio-flow-input-container",children:[t.jsx("input",{type:"text",value:l,onChange:e=>{c(e.target.value)},disabled:!r,onKeyDown:e=>{"Enter"===e.key&&u(e)},placeholder:"Enter your message"}),t.jsx("button",{type:"submit",onClick:u,"aria-label":"Send",disabled:!r,children:t.jsx(T,{size:20})})]})]})}):null},ie=async(e,t)=>(await U.post("/flow",{contents:t},{params:{path:e}})).data,le=(e,t,a="info",s=null,n=void 0,r=!1)=>{if(ue(e))return void setTimeout((()=>le(e,t,a,s,n,r)),200);me(e,!0);let o="number"!=typeof n;r&&(o=!0),pe(e,t,a,s,o),o?me(e,!1):de(e,n)},ce=(e,t=!1)=>document.getElementById(`rf-root-${e}`)||(t?document.body:null),de=(e,t)=>{const a=ce(e,!0);a&&t&&setTimeout((()=>{me(e,!1),a.querySelector(`#${e}-snackbar`)?.remove()}),t)},ue=e=>Boolean(window.localStorage.getItem(`snackbar-${e}.lock`)),me=(e,t)=>{t?window.localStorage.setItem(`snackbar-${e}.lock`,"1"):window.localStorage.removeItem(`snackbar-${e}.lock`)},pe=(e,t,a,s,n)=>{const r=ce(e,!0);if(!r)return;const o=he(e,r);o.className=`show snackbar ${a} ${s?"with-details":""}`,o.textContent="",we(o,t),fe(o,s),n&&ye(o,a,e)},he=(e,t)=>{let a=t.querySelector(`#${e}-snackbar`);return a||(a=document.createElement("div"),a.id=`${e}-snackbar`,t.appendChild(a)),a},we=(e,t)=>{const a=document.createElement("div");a.className="message",a.textContent=t,e.appendChild(a)},fe=(e,t)=>{if(!t)return;const a=document.createElement("details"),s=document.createElement("summary");s.textContent="Details",a.appendChild(s);const n=document.createElement("div");n.textContent="string"==typeof t?t:ge(t),a.appendChild(n),e.appendChild(a)},ge=e=>"string"==typeof e?e:e.detail?e.detail:e.message?e.message:e.statusText?`Error: ${e.statusText}`:"An unexpected error occurred.",ye=(e,t,a)=>{const s=document.createElement("div");s.className="close clickable",s.innerHTML="&times;",s.onclick=()=>{e.className=`hide snackbar ${t}`,setTimeout((()=>{e.remove(),me(a,!1)}),300)},e.appendChild(s)},xe=e=>{let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t|=0}return`wf-${Math.abs(t)}`},je=()=>{const{currentPath:t,pathName:a,refresh:s,onGoUp:r}=B(),[o,i]=e.useState(xe(t)),l=e.useRef(null),c=e.useRef(null),[d,u]=e.useState(!1),[m,p]=e.useState([]),[h,w]=e.useState(t.endsWith(".waldiez")),[f,g]=e.useState(null),y=e.useRef(t),x=e.useRef(a),j=async e=>{if(g(null),e)try{const e=await(async e=>(await U.get("/flow",{params:{path:e}})).data)(t),a=n(e);g(a)}catch(a){404===a?.status&&(le(o,"Failed to load the flow","error",a.message),r())}};e.useEffect((()=>{if(y.current===t&&null!==f)return void window.localStorage.removeItem(`snackbar-${o}.lock`);y.current=t,x.current=a;const e=xe(t);i(e),window.localStorage.removeItem(`snackbar-${e}.lock`);const s=t.endsWith(".waldiez");w(s),j(s)}),[t]);const b=e=>{"string"!=typeof e&&null!==e||(l.current=e)},v=h?window.location.origin.replace("http","ws")+`/ws?path=${t}`:null,{sendJsonMessage:N}=O(v,{reconnectInterval:3e3,reconnectAttempts:10,retryOnError:!0,onError:()=>{le(o,"WebSocket error","error",void 0,3e3)},onClose:e=>{if(![1e3,1001,1005,1006].includes(e.code)){let t=e.reason;t||(t=JSON.stringify({code:e.code,wasClean:e.wasClean,reason:e.reason})),le(o,"WebSocket closed","error",t,3e3)}},onMessage:e=>{let t={};try{t=JSON.parse(e.data)}catch(a){return}if("type"in t&&"data"in t){const{type:e,data:n}=t;switch(e){case"print":(e=>{p((t=>[...t,e]));try{const t=JSON.parse(e);if("error"===t.type){const e=t.data?.details??void 0,a=t.data?.message??"Error running task";le(o,a,"error",e)}}catch(a){}})(n);break;case"input":(e=>{"string"==typeof e&&(c.current=e)})(n);break;case"error":case"info":case"warning":((e,t)=>{"error"===e?le(o,"Flow execution failed","error",t.message):le(o,t,e,null,5e3,!0)})(e,n);break;case"results":(e=>{s().then((()=>{le(o,"Flow execution completed","success")})).catch((e=>{le(o,"Failed to refresh the file browser","error",e.message)})).finally((()=>{b(null);const t="string"==typeof e?e:JSON.stringify({results:e},null,2);p((e=>[...e,t]))}))})(n);break;case"status":b(n)}}},shouldReconnect:()=>h}),C=async e=>{try{await ie(y.current,e),await s()}catch(t){le(o,"Failed to save the flow","error",t.message)}};return{flowId:o,isWaldiez:h,waldiezProps:f,status:l.current,messages:m,prompt:c.current,fileName:x.current,isModalOpen:d,setModalOpen:u,resetPrompt:()=>{c.current=null},onRun:async e=>{l.current=null,N({action:"status"});try{const t=await new Promise(((e,t)=>{const a=setTimeout((()=>{t(new Error("Timeout while waiting for status"))}),5e3),s=l.current,n=setInterval((()=>{s===l.current&&"COMPLETED"!==l.current||(clearInterval(n),clearTimeout(a),e(l.current))}),100)}));"NOT_STARTED"===t||"COMPLETED"===t?(await C(e),p(["Starting the flow..."]),u(!0),N({action:"start"})):le(o,"Flow is already running","info")}catch(t){le(o,"Failed to start the flow","error",t.message)}},onCovert:async(e,t)=>{try{await(async(e,t,a)=>(await ie(e,t),(await U.post("/flow/export",null,{params:{path:e,extension:a}})).data))(y.current,e,t),await s()}catch(a){le(o,"Flow conversion failed","error",a.message)}},onSave:C,onChange:e=>{q((()=>ie(y.current,e).catch((()=>{}))),200)()},onUpload:e=>new Promise((t=>{const a=[],n=e.map((async e=>{let t=`${y.current}`;if(h){const e=y.current.split("/");e.pop(),t=e.join("/")}try{const s=await V(t,e);a.push(s.path)}catch(n){le(o,"Failed to upload the file","error",n.message)}finally{await s()}}));Promise.all(n).then((()=>{t(a)}))})),sendMessage:N}},be=()=>{const{flowId:a,isWaldiez:s,waldiezProps:n,messages:o,prompt:i,fileName:l,isModalOpen:c,sendMessage:d,resetPrompt:u,onRun:m,onCovert:p,onChange:h,onSave:w,setModalOpen:f,onUpload:g}=je();return e.useEffect((()=>{null!==i&&f(!0)}),[i]),s?n?t.jsxs(t.Fragment,{children:[t.jsx(r,{...n,flowId:a,storageId:a,inputPrompt:null,monacoVsPath:"monaco/vs",onUserInput:null,onRun:e=>{m(e)},onChange:h,onUpload:g,onSave:w,onConvert:p}),t.jsx(oe,{isOpen:c,onClose:()=>{f(!1)},messages:o,onSubmit:e=>{u(),d({action:"input",payload:e})},prompt:i,title:l})]}):t.jsx("div",{className:"waldiez-wrapper-no-flow",children:t.jsx("p",{"data-testid":"waldiez-loading-flow",children:"Loading flow..."})}):t.jsx("div",{className:"waldiez-wrapper-no-flow",children:t.jsxs("p",{"data-testid":"waldiez-no-flow",children:["Create a new file or select an existing ",t.jsx("span",{children:".waldiez"})," file to start"]})})},ve=()=>(e.useEffect((()=>{Ne()}),[]),t.jsx("div",{className:"app",children:t.jsx(te,{children:t.jsxs(X,{children:[t.jsx(ae,{}),t.jsx("div",{className:"waldiez-wrapper",children:t.jsx(be,{})})]})})})),Ne=()=>{if(!document.body.classList.contains("waldiez-dark")&&!document.body.classList.contains("waldiez-light")){window.matchMedia("(prefers-color-scheme: dark)").matches?document.body.classList.add("waldiez-dark"):document.body.classList.add("waldiez-light")}};s.createRoot(document.getElementById("root")).render(t.jsx(a.StrictMode,{children:t.jsx(ve,{})}));
