<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Flock UI{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/custom.css') }}">
    <script src="https://unpkg.com/htmx.org@1.9.10" integrity="sha384-D1Kt99CQMDuVetoL1lrYwg5t+9QdHe7NLX/SoJYkXDFfX37iInKRy5xLSi8nO7UC" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { padding-top: 4.5rem; display: grid; grid-template-columns: 250px 1fr; grid-template-rows: auto 1fr auto; grid-template-areas: "header header" "sidebar main" "footer footer"; min-height: 100vh; margin: 0; }
        header.top-header { grid-area: header; border-bottom: 1px solid var(--pico-muted-border-color); padding: 0.5rem 1rem; background-color: var(--pico-card-background-color); display: flex; justify-content: space-between; align-items: center; position: fixed; top: 0; left: 0; right: 0; z-index: 1001;}
        aside.sidebar { grid-area: sidebar; background-color: var(--pico-secondary-background); padding: 1rem; border-right: 1px solid var(--pico-muted-border-color); overflow-y: auto;}
        main.main-content { grid-area: main; padding: 1rem; overflow-y: auto; }
        footer.main-footer { grid-area: footer; padding: 0.5rem 1rem; border-top: 1px solid var(--pico-muted-border-color); font-size: 0.8em; text-align: center;}
        .sidebar nav ul { padding-left: 0; list-style: none; }
        .sidebar nav li { margin-bottom: 0.5rem; }
        .sidebar nav a, .sidebar nav button { display: block; width: 100%; text-align: left; margin-bottom: 0.25rem; background-color: transparent; border-color: var(--pico-primary); color: var(--pico-primary); padding: 0.5rem 0.75rem; }
        .sidebar nav a:hover, .sidebar nav button:hover, .sidebar nav a:focus, .sidebar nav button:focus { background-color: var(--pico-primary-hover-background); border-color: var(--pico-primary-hover-border); color: var(--pico-primary-inverse); }
        .sidebar nav a[aria-current="page"], .sidebar nav button[aria-current="page"] { background-color: var(--pico-primary); border-color: var(--pico-primary); color: var(--pico-primary-inverse); }
        .message-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1001; width: auto; max-width: 400px; }
        .message-container > div { margin-top: 0.5rem; box-shadow: var(--pico-card-box-shadow); display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: var(--pico-border-radius); font-weight: 500;}
        .message-container .success { background-color: var(--pico-ins-color); color: var(--pico-primary-inverse); border: 1px solid var(--pico-ins-color); }
        .message-container .error { background-color: var(--pico-del-color); color: var(--pico-primary-inverse); border: 1px solid var(--pico-del-color); }
        .message-container .close { background: none; border: none; color: inherit; font-size: 1.2rem; cursor: pointer; padding: 0 0.5rem; margin-left: 1rem; }
    </style>
</head>
<body>
    <header class="top-header">
        <span><strong>Flock UI üê§</strong></span>
        {# Use the variables passed from the route handler #}
        {% if current_flock %}
            <small>Current: <code>{{ current_filename or current_flock.name }}</code></small>
        {% else %}
             <small>No Flock Loaded</small>
        {% endif %}
    </header>

    <aside class="sidebar" hx-get="/ui/htmx/sidebar" hx-trigger="load, flockLoaded from:body, flockListChanged from:body" hx-swap="innerHTML">
        <p>Loading navigation...</p><progress></progress>
    </aside>

    <main class="main-content" id="main-content-area">
        {# Initial content is now loaded via HTMX based on the route #}
        <div hx-get="{{ initial_content_url }}" hx-trigger="load" hx-swap="innerHTML">
             <p>Loading content...</p><progress></progress>
        </div>
        {# Render block content if navigating directly and template extends base #}
        {% block content %}{% endblock %} 
    </main>

    <div class="message-container"
         x-data="messageHandler(
            {{ success_message | tojson | safe if success_message else 'null' }},
            {{ error_message | tojson | safe if error_message else 'null' }}
         )">
        <template x-if="showSuccess && successMsg">
             <div class="success" role="alert" @click="showSuccess = false" style="cursor: pointer;">
                <span x-text="successMsg"></span>
                <button type="button" class="close" aria-label="Dismiss">√ó</button>
            </div>
        </template>
        <template x-if="showError && errorMsg">
            <div class="error" role="alert" @click="showError = false" style="cursor: pointer;">
                <span x-text="errorMsg"></span>
                <button type="button" class="close" aria-label="Dismiss">√ó</button>
            </div>
        </template>
    </div>

    <footer class="main-footer">
        <small>Flock UI MVP</small>
    </footer>

    <script>
        function messageHandler(initialSuccessMsg, initialErrorMsg) {
             return {
                showSuccess: !!initialSuccessMsg,
                showError: !!initialErrorMsg,
                successMsg: initialSuccessMsg,
                errorMsg: initialErrorMsg,
                init() {
                    if (this.successMsg) { setTimeout(() => this.showSuccess = false, 5000); }
                    if (this.errorMsg) { setTimeout(() => this.showError = false, 7000); }

                    window.addEventListener('notify', event => {
                        if (event.detail.type === 'success') {
                            this.successMsg = event.detail.message;
                            this.showSuccess = true; this.showError = false;
                            setTimeout(() => this.showSuccess = false, 5000);
                        }
                        if (event.detail.type === 'error') {
                            this.errorMsg = event.detail.message;
                            this.showError = true; this.showSuccess = false;
                            setTimeout(() => this.showError = false, 7000);
                        }
                    });
                }
            };
        }
        function triggerEvent(eventName, detail = {}) {
            htmx.trigger(document.body, eventName, detail);
        }
    </script>
</body>
</html>