import httpx
from mcp.server.fastmcp import FastMCP
import os
import argparse

# åˆå§‹åŒ– MCP æœåŠ¡å™¨
mcp = FastMCP("mcp-gaode-weather-server-unique")

class GaodeWeatherTool:
    def __init__(self, api_key):
        """åˆå§‹åŒ–é«˜å¾·å¤©æ°”å·¥å…·"""
        self.api_key = api_key
        self.base_url = "https://restapi.amap.com/v3/weather/weatherInfo"
        self.headers = {"User-Agent": "weather-app/1.0"}
        
        # åŸå¸‚åç§°åˆ°é«˜å¾·ä»£ç çš„æ˜ å°„è¡¨ï¼ˆä¸­å›½ä¸»è¦åŸå¸‚ï¼‰
        self.city_code_map = {
            # ç›´è¾–å¸‚
            "åŒ—äº¬": "110000",
            "ä¸Šæµ·": "310000",
            "å¤©æ´¥": "120000",
            "é‡åº†": "500000",
            
            # æ²³åŒ—çœ
            "çŸ³å®¶åº„": "130100",
            "å”å±±": "130200",
            "ç§¦çš‡å²›": "130300",
            "é‚¯éƒ¸": "130400",
            "é‚¢å°": "130500",
            "ä¿å®š": "130600",
            "å¼ å®¶å£": "130700",
            "æ‰¿å¾·": "130800",
            "æ²§å·": "130900",
            "å»ŠåŠ": "131000",
            "è¡¡æ°´": "131100",
            
            # å±±è¥¿çœ
            "å¤ªåŸ": "140100",
            "å¤§åŒ": "140200",
            "é˜³æ³‰": "140300",
            "é•¿æ²»": "140400",
            "æ™‹åŸ": "140500",
            "æœ”å·": "140600",
            "æ™‹ä¸­": "140700",
            "è¿åŸ": "140800",
            "å¿»å·": "140900",
            "ä¸´æ±¾": "141000",
            "å•æ¢": "141100",
            
            # å†…è’™å¤è‡ªæ²»åŒº
            "å‘¼å’Œæµ©ç‰¹": "150100",
            "åŒ…å¤´": "150200",
            "ä¹Œæµ·": "150300",
            "èµ¤å³°": "150400",
            "é€šè¾½": "150500",
            "é„‚å°”å¤šæ–¯": "150600",
            "å‘¼ä¼¦è´å°”": "150700",
            "å·´å½¦æ·–å°”": "150800",
            "ä¹Œå…°å¯Ÿå¸ƒ": "150900",
            "å…´å®‰ç›Ÿ": "152200",
            "é”¡æ—éƒ­å‹’ç›Ÿ": "152500",
            "é˜¿æ‹‰å–„ç›Ÿ": "152900",
            
            # è¾½å®çœ
            "æ²ˆé˜³": "210100",
            "å¤§è¿": "210200",
            "éå±±": "210300",
            "æŠšé¡º": "210400",
            "æœ¬æºª": "210500",
            "ä¸¹ä¸œ": "210600",
            "é”¦å·": "210700",
            "è¥å£": "210800",
            "é˜œæ–°": "210900",
            "è¾½é˜³": "211000",
            "ç›˜é”¦": "211100",
            "é“å²­": "211200",
            "æœé˜³": "211300",
            "è‘«èŠ¦å²›": "211400",
            
            # å‰æ—çœ
            "é•¿æ˜¥": "220100",
            "å‰æ—": "220200",
            "å››å¹³": "220300",
            "è¾½æº": "220400",
            "é€šåŒ–": "220500",
            "ç™½å±±": "220600",
            "æ¾åŸ": "220700",
            "ç™½åŸ": "220800",
            "å»¶è¾¹æœé²œæ—è‡ªæ²»å·": "222400",
            
            # é»‘é¾™æ±Ÿçœ
            "å“ˆå°”æ»¨": "230100",
            "é½é½å“ˆå°”": "230200",
            "é¸¡è¥¿": "230300",
            "é¹¤å²—": "230400",
            "åŒé¸­å±±": "230500",
            "å¤§åº†": "230600",
            "ä¼Šæ˜¥": "230700",
            "ä½³æœ¨æ–¯": "230800",
            "ä¸ƒå°æ²³": "230900",
            "ç‰¡ä¸¹æ±Ÿ": "231000",
            "é»‘æ²³": "231100",
            "ç»¥åŒ–": "231200",
            "å¤§å…´å®‰å²­åœ°åŒº": "232700",
            
            # æ±Ÿè‹çœ
            "å—äº¬": "320100",
            "æ— é”¡": "320200",
            "å¾å·": "320300",
            "å¸¸å·": "320400",
            "è‹å·": "320500",
            "å—é€š": "320600",
            "è¿äº‘æ¸¯": "320700",
            "æ·®å®‰": "320800",
            "ç›åŸ": "320900",
            "æ‰¬å·": "321000",
            "é•‡æ±Ÿ": "321100",
            "æ³°å·": "321200",
            "å®¿è¿": "321300",
            
            # æµ™æ±Ÿçœ
            "æ­å·": "330100",
            "å®æ³¢": "330200",
            "æ¸©å·": "330300",
            "å˜‰å…´": "330400",
            "æ¹–å·": "330500",
            "ç»å…´": "330600",
            "é‡‘å": "330700",
            "è¡¢å·": "330800",
            "èˆŸå±±": "330900",
            "å°å·": "331000",
            "ä¸½æ°´": "331100",
            
            # å®‰å¾½çœ
            "åˆè‚¥": "340100",
            "èŠœæ¹–": "340200",
            "èšŒåŸ ": "340300",
            "æ·®å—": "340400",
            "é©¬éå±±": "340500",
            "æ·®åŒ—": "340600",
            "é“œé™µ": "340700",
            "å®‰åº†": "340800",
            "é»„å±±": "341000",
            "æ»å·": "341100",
            "é˜œé˜³": "341200",
            "å®¿å·": "341300",
            "å·¢æ¹–": "341400",
            "å…­å®‰": "341500",
            "äº³å·": "341600",
            "æ± å·": "341700",
            "å®£åŸ": "341800",
            
            # ç¦å»ºçœ
            "ç¦å·": "350100",
            "å¦é—¨": "350200",
            "è†ç”°": "350300",
            "ä¸‰æ˜": "350400",
            "æ³‰å·": "350500",
            "æ¼³å·": "350600",
            "å—å¹³": "350700",
            "é¾™å²©": "350800",
            "å®å¾·": "350900",
            
            # æ±Ÿè¥¿çœ
            "å—æ˜Œ": "360100",
            "æ™¯å¾·é•‡": "360200",
            "èä¹¡": "360300",
            "ä¹æ±Ÿ": "360400",
            "æ–°ä½™": "360500",
            "é¹°æ½­": "360600",
            "èµ£å·": "360700",
            "å‰å®‰": "360800",
            "å®œæ˜¥": "360900",
            "æŠšå·": "361000",
            "ä¸Šé¥¶": "361100",
            
            # å±±ä¸œçœ
            "æµå—": "370100",
            "é’å²›": "370200",
            "æ·„åš": "370300",
            "æ£åº„": "370400",
            "ä¸œè¥": "370500",
            "çƒŸå°": "370600",
            "æ½åŠ": "370700",
            "æµå®": "370800",
            "æ³°å®‰": "370900",
            "å¨æµ·": "371000",
            "æ—¥ç…§": "371100",
            "è±èŠœ": "371200",
            "ä¸´æ²‚": "371300",
            "å¾·å·": "371400",
            "èŠåŸ": "371500",
            "æ»¨å·": "371600",
            "èæ³½": "371700",
            
            # æ²³å—çœ
            "éƒ‘å·": "410100",
            "å¼€å°": "410200",
            "æ´›é˜³": "410300",
            "å¹³é¡¶å±±": "410400",
            "å®‰é˜³": "410500",
            "é¹¤å£": "410600",
            "æ–°ä¹¡": "410700",
            "ç„¦ä½œ": "410800",
            "æ¿®é˜³": "410900",
            "è®¸æ˜Œ": "411000",
            "æ¼¯æ²³": "411100",
            "ä¸‰é—¨å³¡": "411200",
            "å—é˜³": "411300",
            "å•†ä¸˜": "411400",
            "ä¿¡é˜³": "411500",
            "å‘¨å£": "411600",
            "é©»é©¬åº—": "411700",
            "æµæº": "419001",
            
            # æ¹–åŒ—çœ
            "æ­¦æ±‰": "420100",
            "é»„çŸ³": "420200",
            "åå °": "420300",
            "å®œæ˜Œ": "420500",
            "è¥„é˜³": "420600",
            "é„‚å·": "420700",
            "è†é—¨": "420800",
            "å­æ„Ÿ": "420900",
            "è†å·": "421000",
            "é»„å†ˆ": "421100",
            "å’¸å®": "421200",
            "éšå·": "421300",
            "æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·": "422800",
            "ä»™æ¡ƒ": "429004",
            "æ½œæ±Ÿ": "429005",
            "å¤©é—¨": "429006",
            "ç¥å†œæ¶æ—åŒº": "429021",
            
            # æ¹–å—çœ
            "é•¿æ²™": "430100",
            "æ ªæ´²": "430200",
            "æ¹˜æ½­": "430300",
            "è¡¡é˜³": "430400",
            "é‚µé˜³": "430500",
            "å²³é˜³": "430600",
            "å¸¸å¾·": "430700",
            "å¼ å®¶ç•Œ": "430800",
            "ç›Šé˜³": "430900",
            "éƒ´å·": "431000",
            "æ°¸å·": "431100",
            "æ€€åŒ–": "431200",
            "å¨„åº•": "431300",
            "æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·": "433100",
            
            # å¹¿ä¸œçœ
            "å¹¿å·": "440100",
            "éŸ¶å…³": "440200",
            "æ·±åœ³": "440300",
            "ç æµ·": "440400",
            "æ±•å¤´": "440500",
            "ä½›å±±": "440600",
            "æ±Ÿé—¨": "440700",
            "æ¹›æ±Ÿ": "440800",
            "èŒ‚å": "440900",
            "è‚‡åº†": "441200",
            "æƒ å·": "441300",
            "æ¢…å·": "441400",
            "æ±•å°¾": "441500",
            "æ²³æº": "441600",
            "é˜³æ±Ÿ": "441700",
            "æ¸…è¿œ": "441800",
            "ä¸œè": "441900",
            "ä¸­å±±": "442000",
            "æ½®å·": "445100",
            "æ­é˜³": "445200",
            "äº‘æµ®": "445300",
            
            # å¹¿è¥¿å£®æ—è‡ªæ²»åŒº
            "å—å®": "450100",
            "æŸ³å·": "450200",
            "æ¡‚æ—": "450300",
            "æ¢§å·": "450400",
            "åŒ—æµ·": "450500",
            "é˜²åŸæ¸¯": "450600",
            "é’¦å·": "450700",
            "è´µæ¸¯": "450800",
            "ç‰æ—": "450900",
            "ç™¾è‰²": "451000",
            "è´ºå·": "451100",
            "æ²³æ± ": "451200",
            "æ¥å®¾": "451300",
            "å´‡å·¦": "451400",
            
            # æµ·å—çœ
            "æµ·å£": "460100",
            "ä¸‰äºš": "460200",
            "ä¸‰æ²™": "460300",
            "å„‹å·": "460400",
            
            # å››å·çœ
            "æˆéƒ½": "510100",
            "è‡ªè´¡": "510300",
            "æ”€æèŠ±": "510400",
            "æ³¸å·": "510500",
            "å¾·é˜³": "510600",
            "ç»µé˜³": "510700",
            "å¹¿å…ƒ": "510800",
            "é‚å®": "510900",
            "å†…æ±Ÿ": "511000",
            "ä¹å±±": "511100",
            "å—å……": "511300",
            "çœ‰å±±": "511400",
            "å®œå®¾": "511500",
            "å¹¿å®‰": "511600",
            "è¾¾å·": "511700",
            "é›…å®‰": "511800",
            "å·´ä¸­": "511900",
            "èµ„é˜³": "512000",
            "é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·": "513200",
            "ç”˜å­œè—æ—è‡ªæ²»å·": "513300",
            "å‡‰å±±å½æ—è‡ªæ²»å·": "513400",
            
            # è´µå·çœ
            "è´µé˜³": "520100",
            "å…­ç›˜æ°´": "520200",
            "éµä¹‰": "520300",
            "å®‰é¡º": "520400",
            "æ¯•èŠ‚": "520500",
            "é“œä»": "520600",
            "é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·": "522300",
            "é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·": "522600",
            "é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·": "522700",
            
            # äº‘å—çœ
            "æ˜†æ˜": "530100",
            "æ›²é–": "530300",
            "ç‰æºª": "530400",
            "ä¿å±±": "530500",
            "æ˜­é€š": "530600",
            "ä¸½æ±Ÿ": "530700",
            "æ™®æ´±": "530800",
            "ä¸´æ²§": "530900",
            "æ¥šé›„å½æ—è‡ªæ²»å·": "532300",
            "çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·": "532500",
            "æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·": "532600",
            "è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·": "532800",
            "å¤§ç†ç™½æ—è‡ªæ²»å·": "532900",
            "å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·": "533100",
            "æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·": "533300",
            "è¿ªåº†è—æ—è‡ªæ²»å·": "533400",
            
            # è¥¿è—è‡ªæ²»åŒº
            "æ‹‰è¨": "540100",
            "æ—¥å–€åˆ™": "540200",
            "æ˜Œéƒ½": "540300",
            "æ—èŠ": "540400",
            "å±±å—": "540500",
            "é‚£æ›²": "540600",
            "é˜¿é‡Œåœ°åŒº": "542500",
            
            # é™•è¥¿çœ
            "è¥¿å®‰": "610100",
            "é“œå·": "610200",
            "å®é¸¡": "610300",
            "å’¸é˜³": "610400",
            "æ¸­å—": "610500",
            "å»¶å®‰": "610600",
            "æ±‰ä¸­": "610700",
            "æ¦†æ—": "610800",
            "å®‰åº·": "610900",
            "å•†æ´›": "611000",
            
            # ç”˜è‚ƒçœ
            "å…°å·": "620100",
            "å˜‰å³ªå…³": "620200",
            "é‡‘æ˜Œ": "620300",
            "ç™½é“¶": "620400",
            "å¤©æ°´": "620500",
            "æ­¦å¨": "620600",
            "å¼ æ–": "620700",
            "å¹³å‡‰": "620800",
            "é…’æ³‰": "620900",
            "åº†é˜³": "621000",
            "å®šè¥¿": "621100",
            "é™‡å—": "621200",
            "ä¸´å¤å›æ—è‡ªæ²»å·": "622900",
            "ç”˜å—è—æ—è‡ªæ²»å·": "623000",
            
            # é’æµ·çœ
            "è¥¿å®": "630100",
            "æµ·ä¸œ": "630200",
            "æµ·åŒ—è—æ—è‡ªæ²»å·": "632200",
            "é»„å—è—æ—è‡ªæ²»å·": "632300",
            "æµ·å—è—æ—è‡ªæ²»å·": "632500",
            "æœæ´›è—æ—è‡ªæ²»å·": "632600",
            "ç‰æ ‘è—æ—è‡ªæ²»å·": "632700",
            "æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·": "632800",
            
            # å®å¤å›æ—è‡ªæ²»åŒº
            "é“¶å·": "640100",
            "çŸ³å˜´å±±": "640200",
            "å´å¿ ": "640300",
            "å›ºåŸ": "640400",
            "ä¸­å«": "640500",
            
            # æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº
            "ä¹Œé²æœ¨é½": "650100",
            "å…‹æ‹‰ç›ä¾": "650200",
            "åé²ç•ª": "650400",
            "å“ˆå¯†": "650500",
            "æ˜Œå‰å›æ—è‡ªæ²»å·": "652300",
            "åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·": "652700",
            "å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·": "652800",
            "é˜¿å…‹è‹åœ°åŒº": "652900",
            "å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·": "653000",
            "å–€ä»€åœ°åŒº": "653100",
            "å’Œç”°åœ°åŒº": "653200",
            "ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·": "654000",
            "å¡”åŸåœ°åŒº": "654200",
            "é˜¿å‹’æ³°åœ°åŒº": "654300",
            "çŸ³æ²³å­": "659001",
            "é˜¿æ‹‰å°”": "659002",
            "å›¾æœ¨èˆ’å…‹": "659003",
            "äº”å®¶æ¸ ": "659004",
            "åŒ—å±¯": "659005",
            "é“é—¨å…³": "659006",
            "åŒæ²³": "659007",
            "å¯å…‹è¾¾æ‹‰": "659008",
            "æ˜†ç‰": "659009",
        }

    async def query_weather(self, city: str, extensions: str = "base") -> dict:
        """
        ä»é«˜å¾·åœ°å›¾ API æŸ¥è¯¢å¤©æ°”ä¿¡æ¯ã€‚
        :param city: åŸå¸‚åç§°æˆ–é«˜å¾·åœ°å›¾åŸå¸‚ä»£ç 
        :param extensions: 'base' ä¸ºå®æ—¶å¤©æ°”ï¼Œ'all' ä¸ºé¢„æŠ¥å¤©æ°”
        :return: å¤©æ°”æ•°æ®å­—å…¸ï¼Œè‹¥å‡ºé”™åˆ™åŒ…å« error å­—æ®µ
        """
        # ä¼˜å…ˆä½¿ç”¨æ˜ å°„è¡¨ä¸­çš„ä»£ç ï¼Œå¦åˆ™ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å€¼ï¼ˆå¯èƒ½æ˜¯ç”¨æˆ·æä¾›çš„ä»£ç ï¼‰
        city_code = self.city_code_map.get(city, city)
        
        params = {
            "key": self.api_key,
            "city": city_code,
            "extensions": extensions,
            "output": "json"
        }
        print(f"DEBUG: Querying weather for city: {city} (code: {city_code}), params: {params}")
        
        async with httpx.AsyncClient() as client:
            try:
                response = await client.get(self.base_url, params=params, headers=self.headers, timeout=10.0)
                print(f"DEBUG: Response status: {response.status_code}, content: {response.text[:500]}...")
                response.raise_for_status()
                data = response.json()
                
                if data.get("status") != "1":
                    # æ£€æŸ¥æ˜¯å¦æ˜¯åŸå¸‚ä»£ç æ— æ•ˆå¯¼è‡´çš„é”™è¯¯
                    if data.get("info") == "INVALID_PARAMS" and city != city_code:
                        return {"error": f"æœªæ‰¾åˆ°åŸå¸‚ '{city}' çš„ä»£ç ï¼Œè¯·å°è¯•å…¶ä»–åŸå¸‚"}
                    return {"error": f"API error: {data.get('info', 'Unknown error')}"}
                
                lives = data.get("lives", [])
                if not lives:
                    return {"message": "æœªæ‰¾åˆ°è¯¥åŸå¸‚çš„å¤©æ°”æ•°æ®"}
                
                weather_info = lives[0]
                result = {
                    "city": weather_info.get("city", city),
                    "weather": weather_info.get("weather", "Unknown"),
                    "temperature": weather_info.get("temperature", "Unknown"),
                    "winddirection": weather_info.get("winddirection", "Unknown"),
                    "windpower": weather_info.get("windpower", "Unknown"),
                    "humidity": weather_info.get("humidity", "Unknown"),
                    "reporttime": weather_info.get("reporttime", "Unknown")
                }
                return result
            except httpx.RequestException as e:
                return {"error": f"Weather query error: {str(e)}"}

    def format_weather(self, weather_data: dict) -> str:
        """å°†å¤©æ°”æ•°æ®æ ¼å¼åŒ–ä¸ºæ˜“è¯»æ–‡æœ¬"""
        if "error" in weather_data:
            return f"âš ï¸ {weather_data['error']}"
        if "message" in weather_data:
            return f"âš ï¸ {weather_data['message']}"
        
        return (
            f"ğŸŒ {weather_data['city']}\n"
            f"ğŸŒ¡ æ¸©åº¦: {weather_data['temperature']}Â°C\n"
            f"ğŸ’§ æ¹¿åº¦: {weather_data['humidity']}%\n"
            f"ğŸŒ¬ é£å‘: {weather_data['winddirection']} é£åŠ›: {weather_data['windpower']} çº§\n"
            f"ğŸŒ¤ å¤©æ°”: {weather_data['weather']}\n"
            f"â° æ›´æ–°æ—¶é—´: {weather_data['reporttime']}\n"
        )

def main():
    print("DEBUG: Starting MCP WeatherServer")
    parser = argparse.ArgumentParser(description="Run MCP WeatherServer")
    parser.add_argument("--api_key", type=str, required=True, help="é«˜å¾·åœ°å›¾ API å¯†é’¥")
    args = parser.parse_args()

    # ä½¿ç”¨å‘½ä»¤è¡Œæä¾›çš„ API å¯†é’¥å®ä¾‹åŒ–å¤©æ°”å·¥å…·
    weather_tool = GaodeWeatherTool(api_key=args.api_key)

    @mcp.tool()
    async def query_weather(city_name: str) -> str:
        """
        è¾“å…¥åŸå¸‚åç§°ï¼Œè¿”å›ä»Šæ—¥å¤©æ°”æŸ¥è¯¢ç»“æœã€‚
        :param city_name: åŸå¸‚åç§°ï¼ˆå¦‚"æ­å·"ï¼‰
        :return: æ ¼å¼åŒ–åçš„å¤©æ°”ä¿¡æ¯
        """
        data = await weather_tool.query_weather(city_name, extensions="base")
        return weather_tool.format_weather(data)

    mcp.run(transport='stdio')

if __name__ == "__main__":
    main()